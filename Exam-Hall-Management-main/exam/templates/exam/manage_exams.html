<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Exams</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 1rem;
            border: 1px solid #dee2e6;
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        /* Style the hall containers for a clean, clickable box look - REMOVING CUSTOM STYLING */
        /* .hall-checkbox-container {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 10px;
            margin-top: 5px;
            transition: background-color 0.15s;
            cursor: pointer;
        }
        .hall-checkbox-container:hover {
            background-color: #f0f0f0;
        } */
        /* Ensure the checkbox itself stays aligned */
        .hall-checkbox-container input[type="checkbox"] {
            margin-right: 10px;
        }
        /* Style for required label (using the generic .form-label) */
        .form-label {
            font-weight: 500;
        }
    </style>
</head>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // 1. Identify the department selector and the Total Students input field
    const $departmentSelector = $('#id_department');
    const $totalStudentsInput = $('#id_total_students'); 
    
    // 2. Function to fetch and update the student count
    function updateStudentCount() {
        // Handle select-multiple: val() returns an array of selected option values (Department IDs)
        const selectedDepartmentIds = $departmentSelector.val(); 
        
        if (selectedDepartmentIds && selectedDepartmentIds.length > 0) {
            // Correctly form the URL parameters array: department_ids=1&department_ids=2...
            const data = selectedDepartmentIds.map(id => `department_ids=${id}`).join('&');

            $.ajax({
                url: '{% url "exam:get_student_count" %}', 
                type: 'GET',
                data: data,
                success: function(response) {
                    $totalStudentsInput.val(response.total_students);
                },
                error: function() {
                    $totalStudentsInput.val('Error');
                }
            });
        } else {
            $totalStudentsInput.val(0);
        }
    }

    // 3. Attach the event handler to the department selector
    $departmentSelector.on('change', updateStudentCount);

    // Initial call to update student count on page load
    updateStudentCount();
});
</script>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Manage Exams</h2>
            <a href="{% url 'exam:admin_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        </div>

        {# --- START: CRITICAL POPUP MESSAGE LOGIC (SAFE) --- #}
        {% if messages %}
            {# Render messages into a JSON string stored in a data attribute (escape to keep JS safe) #}
            <div id="django-messages"
                 data-messages='[{% for message in messages %}{"tags":"{{ message.tags|escapejs }}","message":"{{ message|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'
                 style="display:none"></div>

            <script>
                (function() {
                    try {
                        var container = document.getElementById('django-messages');
                        var raw = container ? container.getAttribute('data-messages') : '[]';
                        var messages = JSON.parse(raw || '[]');

                        messages.forEach(function(m) {
                            if (m.tags === 'error') {
                                // Show critical errors as a blocking alert
                                alert("ðŸš¨ Scheduling Error:\n\n" + m.message);
                            } else {
                                // Insert non-error messages as bootstrap alerts at top of container
                                var wrapper = document.createElement('div');
                                wrapper.className = 'alert alert-' + (m.tags || 'info') + ' alert-dismissible fade show mb-3';
                                wrapper.setAttribute('role', 'alert');
                                wrapper.innerHTML = m.message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
                                var root = document.querySelector('.container') || document.body;
                                root.insertBefore(wrapper, root.firstChild);
                            }
                        });
                    } catch (e) {
                        // fail silently (log for debugging)
                        console.error('Error processing Django messages:', e);
                    }
                })();
            </script>
        {% endif %}
        {# --- END: CRITICAL POPUP MESSAGE LOGIC (SAFE) --- #}


        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card stats-card h-100 shadow-sm bg-primary text-white">
                    <div class="card-body text-center">
                        <h3 class="card-title">{{ stats.total }}</h3>
                        <p class="card-text">Total Exams</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card h-100 shadow-sm bg-success text-white">
                    <div class="card-body text-center">
                        <h3 class="card-title">{{ stats.upcoming }}</h3>
                        <p class="card-text">Upcoming Exams</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card h-100 shadow-sm bg-secondary text-white">
                    <div class="card-body text-center">
                        <h3 class="card-title">{{ stats.completed }}</h3>
                        <p class="card-text">Completed Exams</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <p>
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#scheduleExamForm" aria-expanded="false" aria-controls="scheduleExamForm">
                    <i class="bi bi-plus-circle"></i> Schedule New Exam
                </button>
            </p>
            <div class="collapse{% if form.errors %} show{% endif %}" id="scheduleExamForm">
                <div class="card card-body shadow-sm p-4">
                    <h3 class="card-title text-center mb-4">New Exam Details</h3>
                    
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="row">
                            
                            {% comment %} Left Column Fields (Exam Name, Time) {% endcomment %}
                            <div class="col-md-6">
                                {% for field in form %}
                                    {% comment %} **REMOVED: or field.name == 'is_combined'** {% endcomment %}
                                    {% if field.name == 'exam_name' or field.name == 'date' or field.name == 'start_time' or field.name == 'end_time' %}
                                        <div class="mb-3">
                                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                            {{ field }}
                                            {% if field.errors %}
                                                <div class="invalid-feedback d-block">{% for error in field.errors %}{{ error }}{% endfor %}</div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                
                                {% comment %} **REMOVED: is_combined field rendering block** {% endcomment %}
                            </div> 
                            
                            {% comment %} Right Column Fields (Department, Halls) {% endcomment %}
                            <div class="col-md-6">
                                {% for field in form %}
                                    {% if field.name == 'department' or field.name == 'halls' %}
                                        <div class="mb-3">
                                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                            
                                            {% if field.name == 'halls' %}
                                                {# START: MODIFIED HALLS RENDERING - Removing custom checkbox container style #}
                                                <div class="row g-2">
                                                    {% for choice in field %}
                                                        <div class="col-6"> 
                                                            {# Removed class="hall-checkbox-container w-100" and removed choice.tag from label #}
                                                            <label class="form-check" for="{{ choice.id_for_label }}">
                                                                {{ choice.tag }} {# This is the actual <input type="checkbox"> #}
                                                                {{ choice.choice_label }}
                                                            </label>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                                {# END: MODIFIED HALLS RENDERING #}
                                            {% elif field.name == 'department' %}
                                                {{ field }}
                                            {% else %}
                                                {{ field }}
                                            {% endif %}

                                            {% if field.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in field.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        {% for field in form %}
                            {% if field.name == 'total_students' %}
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                        {{ field }}
                                        {% if field.errors %}
                                            <div class="invalid-feedback d-block">{% for error in field.errors %}{{ error }}{% endfor %}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}

                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-primary btn-lg">Add Exam</button>
                        </div>
                    </form>
                    </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                <h3 class="mb-0">Scheduled Exams</h3>
            </div>
            <div class="card-body">
                <form method="get" class="mb-4">
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label for="{{ filter_form.department.id_for_label }}" class="form-label">{{ filter_form.department.label }}</label>
                            {{ filter_form.department }}
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-info">Filter</button>
                            <a href="{% url 'exam:manage_exams' %}" class="btn btn-outline-secondary">Clear</a>
                        </div>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Exam Name</th>
                                <th scope="col">Department(s)</th>
                                <th scope="col">Date & Time</th>
                                <th scope="col">Halls</th>
                                <th scope="col">Invigilators</th>
                                <th scope="col" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exam in exams %}
                            <tr>
                                <td><strong>{{ exam.exam_name }}</strong></td>
                                <td>
                                    {% for dept in exam.department.all %}
                                        <span class="badge bg-secondary">{{ dept.name }}</span>
                                    {% endfor %}
                                </td>
                                <td>{{ exam.date }}<br><small class="text-muted">{{ exam.start_time|time:"P" }} - {{ exam.end_time|time:"P" }}</small></td>
                                <td>
                                    {% for hall in exam.halls.all %}
                                        {{ hall.hall_name }}{% if not forloop.last %}, {% endif %}
                                    {% empty %}
                                        <span class="text-muted">N/A</span>
                                    {% endfor %}
                                </td>
                                
                                <td>
                                    {% if exam.consolidated_invigilator and exam.consolidated_invigilator != 'None assigned' %}
                                        <div>
                                            <strong>{{ exam.consolidated_invigilator | safe }}</strong>
                                        </div>
                                    {% else %}
                                        <span class="text-danger">None assigned</span>
                                    {% endif %}
                                </td>
                                
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'exam:edit_exam' exam.id %}" class="btn btn-sm btn-outline-primary" title="Edit"><i class="bi bi-pencil-square"></i></a>
                                        
                                        <a href="{% url 'exam:assign_invigilator' exam.id %}" class="btn btn-sm btn-outline-success" title="Assign Invigilators"><i class="bi bi-person-plus"></i></a>
                                        
                                        <a href="{% url 'exam:all_seating_plans' exam.id %}" class="btn btn-sm btn-outline-info" title="View Seating Plan"><i class="bi bi-grid-3x3-gap"></i></a>
                                        <a href="{% url 'exam:delete_exam' exam.id %}" class="btn btn-sm btn-outline-danger" title="Delete"><i class="bi bi-trash"></i></a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">No exams scheduled.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>